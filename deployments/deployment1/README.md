# FRA-SSN-AWS - Deployment Pattern 1

Architecture details, documentation, and troubleshooting guidance about this deployment pattern can be found in the FRA-SSN-AWS [Wiki](https://github.com/hashicorp/fra-ssn-aws/wiki).

## Build this infrastructure

Before deploying apps/services we must build the infrastructure upon which they will run. We shall use `terraform` to create:

* 1x HCP Consul cluster
* 3x VPCs
* 2x EKS clusters
* 1x ECS cluster

NOTE: 20 - 25 mins build time

```sh
cd DEPLOYMENTS/deloyment1/infrastructure
terraform init
terraform plan
terraform apply
```

NOTE: To avoid name clashes, each deployment has a unique identifier. In this example, that unique ID is `y1g14o`, which you will see in the commands below. YOUR UNIQUE ID WILL BE DIFFERENT!

Once the `terraform apply` has successfully complete it share output including, among other things, two `kubeconfig` files which contain information for executing `kubectl` commands. Copy the `dev` and `prod` config files to their respective `services/` directories, like so:

```sh
cp kubeconfig_hcp-consul-y1g14o-eks-dev ../services/k8s-dev-app
cp kubeconfig_hcp-consul-y1g14o-eks-prod ../services/k8s-prod-app
```

## Deploying Services onto the EKS Prod environment

Lets get the production version of our demonstration app up and running:


## Deploying Services onto the EKS Dev environment

Lets get the development version of our demonstration app up and running:

```sh
cd ../services/k8s-dev-app
export KUBECONFIG=kubeconfig_hcp-consul-y1g14o-eks-dev
kubectl get nodes
kubectl get pods
kubectl get services
```

With comminication tested/established we are now ready to deploy:
```sh
kubectl apply -f manifests/
```

When its finished, take a look at what's happened with the following commands:

```sh
kubectl get pods
kubectl describe pods consul-eks-dev-client-db7pv
kubectl get services
kubectl describe services consul-eks-dev-ingress-gateway
```

If you want to programmatically fetch the Ingress Gateway's external hostname:
```sh
kubectl get services consul-eks-dev-ingress-gateway --output jsonpath='{.status.loadBalancer.ingress[0].hostname}'
```

## Uninstalling the deployed service


`kubectl delete -f manifests/`

Review the deletion using `kubectl get services` 


More commands to experiment with can be found here:
https://kubernetes.io/docs/reference/kubectl/cheatsheet/#viewing-finding-resources

## Removing the infrastructure:

```sh
cd ../../infrastructure 
terraform destroy
```

# Troubleshooting

NOTE: if you perform a `terraform destroy` (from within the `infrastructure/` directory) it will likely fail with a message as such:

```sh
module.hcp_vpc_eks_dev.module.vpc.aws_internet_gateway.this[0]: Still destroying... [id=igw-01c8895136322dcf0, 20m40s elapsed]
module.hcp_vpc_eks_dev.module.vpc.aws_internet_gateway.this[0]: Still destroying... [id=igw-01c8895136322dcf0, 20m50s elapsed]
module.hcp_vpc_eks_dev.module.vpc.aws_internet_gateway.this[0]: Still destroying... [id=igw-01c8895136322dcf0, 21m0s elapsed]
module.hcp_vpc_eks_dev.module.vpc.aws_internet_gateway.this[0]: Still destroying... [id=igw-01c8895136322dcf0, 21m10s elapsed]
╷
│ Error: error detaching EC2 Internet Gateway (igw-01c8895136322dcf0) from VPC (vpc-0a1d60da86c95ac61): DependencyViolation: Network vpc-0a1d60da86c95ac61 has some mapped public address(es). Please unmap those public address(es) before detaching the gateway.
│       status code: 400, request id: 6f75d13b-9e6f-480a-a9a8-6d5e9f4c954d
│ 
│ 
╵
╷
│ Error: uninstallation completed with 1 error(s): timed out waiting for the condition
```

This is because the application we deployed required for kubernetes to configure an external address associated with the infrastructure that was not generated by terraform and, therefore, not part of terraforms state file.

This is easily solved. Note in the error above that it is specifically referring to the resource that is causing the dependancy violation - its a 'network interface' attached to the Internet Gateway `igw-01c8895136322dcf0`. Delete this resource via the AWS Conole and re-run the `terraform destroy`

Navigate to here:
https://us-west-2.console.aws.amazon.com/ec2/home?region=us-west-2#NIC:

Select all, detach.

If terraform has times out, simply run the `terraform destroy` again.

NOTE: Occasionally one must manually delete the EKS security group in the VPC section also.






cp kubeconfig_hcp-consul-y1g14o-eks-dev ../services/k8s-dev-app
cp kubeconfig_hcp-consul-y1g14o-eks-prod ../services/k8s-prod-app
cd ../services/k8s-dev-app
export KUBECONFIG=kubeconfig_hcp-consul-y1g14o-eks-dev
kubectl get nodes
kubectl get pods

ls
kubectl apply -f manifests/



# Tested versions

This deployment pattern was tested with the following versions:

```sh
Terraform v1.1.9
on darwin_amd64
+ provider registry.terraform.io/gavinbunney/kubectl v1.14.0
+ provider registry.terraform.io/hashicorp/aws v3.75.1
+ provider registry.terraform.io/hashicorp/cloudinit v2.2.0
+ provider registry.terraform.io/hashicorp/consul v2.15.1
+ provider registry.terraform.io/hashicorp/hcp v0.26.0
+ provider registry.terraform.io/hashicorp/helm v2.5.1
+ provider registry.terraform.io/hashicorp/http v2.1.0
+ provider registry.terraform.io/hashicorp/kubernetes v2.11.0
+ provider registry.terraform.io/hashicorp/local v2.2.2
+ provider registry.terraform.io/hashicorp/random v3.1.3
+ provider registry.terraform.io/hashicorp/template v2.2.0
+ provider registry.terraform.io/hashicorp/tls v3.3.0
+ provider registry.terraform.io/terraform-aws-modules/http v2.4.1
```